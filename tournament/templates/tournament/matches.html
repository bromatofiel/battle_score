{% extends "tournament/tournament_base.html" %}
{% load i18n %}

{% block title %}{{ tournament.name }} - {% trans "Matches" %}{% endblock %}

{% block tournament_content %}
<div class="space-y-8">
    {% if can_start_tournament %}
        <!-- Tournament not started yet -->
        <div class="glass rounded-3xl p-12 text-center border-dashed border-2 border-emerald-500/30">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-emerald-500/10 flex items-center justify-center">
                <svg class="w-10 h-10 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-3">{% trans "Prêt à démarrer ?" %}</h2>
            <p class="text-slate-400 mb-8 max-w-md mx-auto">{% trans "Démarrez le tournoi pour pouvoir créer des matches et enregistrer les scores." %}</p>
            <form method="post" action="{% url 'tournament:start' tournament.id %}">
                {% csrf_token %}
                <button type="submit" class="px-8 py-4 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold text-lg shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/50 hover:scale-105 transition-all flex items-center gap-3 mx-auto">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                    </svg>
                    {% trans "Démarrer le tournoi" %}
                </button>
            </form>
        </div>
    {% else %}
        <!-- Header with controls -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">{% trans "Matches" %}</h1>
                <p class="text-slate-400">{% trans "Suivez le déroulement de la compétition." %}</p>
            </div>

            {% if is_admin %}
            <div class="flex items-center gap-4 flex-wrap">
                <!-- Auto-creation button -->
                {% if tournament.auto_match_creation %}
                    <!-- Active state: green button, click to disable immediately -->
                    <form method="post" action="{% url 'tournament:disable_auto_match' tournament.id %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 hover:bg-emerald-500/30 transition-all">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <span class="text-sm font-medium">{% trans "Génération auto" %}</span>
                            <span class="text-xs text-emerald-300 bg-emerald-500/30 px-2 py-0.5 rounded-full">{{ tournament.nb_team_matches }} {% trans "matchs/éq" %}</span>
                        </button>
                    </form>
                {% else %}
                    <!-- Inactive state: gray button, click to open modal -->
                    <button type="button" onclick="document.getElementById('auto-match-modal').showModal()" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-slate-700/50 border border-slate-600 text-slate-400 hover:bg-slate-700 hover:text-slate-300 transition-all">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                        </svg>
                        <span class="text-sm font-medium">{% trans "Génération auto" %}</span>
                    </button>
                {% endif %}

                {% if can_create_matches %}
                <a href="{% url 'tournament:match_create' tournament.id %}" class="px-6 py-2.5 rounded-xl btn-primary text-sm font-bold text-white shadow-lg shadow-blue-500/20 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    {% trans "Créer" %}
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Matches Sections -->
        {% if not has_matches %}
            <div class="py-12 text-center glass rounded-3xl border-dashed border-white/10">
                <svg class="w-12 h-12 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <p class="text-slate-500 mb-4">{% trans "Aucun match créé pour le moment." %}</p>
                {% if can_create_matches %}
                <a href="{% url 'tournament:match_create' tournament.id %}" class="inline-flex items-center gap-2 px-6 py-2.5 rounded-xl btn-primary text-sm font-bold text-white">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    {% trans "Créer le premier match" %}
                </a>
                {% endif %}
            </div>
        {% else %}
            <!-- Section: En cours -->
            {% if matches_ongoing %}
            <div class="space-y-4">
                <h3 class="text-lg font-bold text-amber-400 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    {% trans "En cours" %}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for match in matches_ongoing %}
                        {% include "tournament/_match_card.html" %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Section: À venir -->
            {% if matches_coming %}
            <div class="space-y-2">
                <h3 class="text-lg font-bold text-slate-400 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    {% trans "À venir" %}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    {% for match in matches_coming %}
                        {% include "tournament/_match_card_coming.html" %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Section: Terminés -->
            {% if matches_done %}
            <div class="space-y-2">
                <h3 class="text-lg font-bold text-emerald-400 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    {% trans "Terminés" %}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    {% for match in matches_done %}
                        {% include "tournament/_match_card_done.html" %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% endif %}
    {% endif %}
</div>

<!-- Modal for enabling auto-match -->
<dialog id="auto-match-modal" class="bg-transparent p-0 max-w-md w-full backdrop:bg-black/50">
    <div class="glass rounded-3xl p-8 border border-white/10">
        <h3 class="text-xl font-bold text-white mb-2">{% trans "Génération automatique" %}</h3>
        <p class="text-slate-400 text-sm mb-6">{% trans "Les matchs suivants seront créés automatiquement dès qu'un match se termine." %}</p>

        <form method="post" action="{% url 'tournament:enable_auto_match' tournament.id %}">
            {% csrf_token %}
            <div class="mb-6">
                <label class="block text-sm text-slate-300 mb-2">{% trans "Nombre de matchs à disputer pour chaque équipe" %}</label>
                <input type="number" name="nb_team_matches" value="{{ tournament.nb_team_matches|default:'3' }}" min="1" max="100" required class="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-600 text-white text-center text-lg font-bold focus:border-emerald-500 focus:outline-none">
            </div>

            <div class="flex gap-3">
                <button type="button" onclick="document.getElementById('auto-match-modal').close()" class="flex-1 px-4 py-3 rounded-xl bg-slate-700 text-slate-300 font-medium hover:bg-slate-600 transition-colors">
                    {% trans "Annuler" %}
                </button>
                <button type="submit" class="flex-1 px-4 py-3 rounded-xl bg-emerald-500 text-white font-bold hover:bg-emerald-400 transition-colors">
                    {% trans "Activer" %}
                </button>
            </div>
        </form>
    </div>
</dialog>
{% endblock %}
